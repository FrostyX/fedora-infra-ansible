# create a new backup server system
# NOTE: should be used with --limit most of the time
# NOTE: make sure there is room/space for this instance on the buildvmhost
# NOTE: most of these vars come from group_vars/backup_server or from hostvars

- name: make backup server system
  hosts: backup03.phx2.fedoraproject.org
  user: root
  gather_facts: True

  vars_files: 
   - /srv/web/infra/ansible/vars/global.yml
   - ${private}/vars.yml
   - ${vars}/${ansible_distribution}.yml

  roles:
  - /srv/web/infra/ansible/roles/base
  - /srv/web/infra/ansible/roles/rkhunter
  - /srv/web/infra/ansible/roles/denyhosts
  - /srv/web/infra/ansible/roles/nagios_client
  - /srv/web/infra/ansible/roles/fas_client

  tasks:
  - include: $tasks/hosts.yml
  - include: $tasks/yumrepos.yml
  - include: $tasks/2fa_client.yml
  - include: $tasks/motd.yml
  - include: $tasks/sudo.yml
  - include: $tasks/mysql_server.yml
  - include: $tasks/rdiff_backup_server.yml

  - name: Create GNOME backup user
    user: name=gnomebackup state=present home=/fedora_backup/gnome/ createhome=yes shell=/sbin/nologin
  - name:  Add a Directory for the Excludes list
    file: dest=/fedora-backup/gnome/excludes owner=gnomebackup group=gnomebackup state=directory
  - name:  Add a Directory for the Log files
    file: dest=/fedora-backup/gnome/logs owner=gnomebackup group=gnomebackup state=directory
  - name: Install GNOME backup key
    file: src=${private}/gnome_backup_id.rsa path=/fedora_backup/gnome/backup_id.rsa mode=0600
  - name: Install GNOME backup script
    file: src=$files/gnome/backup.sh path=/fedora_backup/gnome/backup.sh mode=0700
  - name: Schedule the GNOME backup script
    cron: name="Backup" hour=5 job="(cd /fedora_backup/gnome/; ./backup.sh)" user=gnomebackup
  - name:  Add Directories
    file: dest=/fedora-backup/gnome/{{ item }} owner=gnomebackup group=gnomebackup state=directory
    with_items: 
    - signal.gnome.org
    - webapps2.gnome.org
    - clutter.gnome.org
    - blogs.gnome.org
    - view.gnome.org
    - puppet.gnome.org
    - extensions.gnome.org
    - chooser.gnome.org
    - git.gnome.org
    - webapps.gnome.org
    - socket.gnome.org
    - bugzilla-web.gnome.org
    - progress.gnome.org
    - clipboard.gnome.org
    - drawable.gnome.org
    - vbox.gnome.org
    - cloud-ssh.gnome.org
    - bastion.gnome.org
    - spinner.gnome.org
    - master.gnome.org
    - live.gnome.org
    - combobox.gnome.org
    - restaurant.gnome.org
    - expander.gnome.org

  handlers:
  - include: $handlers/restart_services.yml
