# requires --extra-vars="hosts=hostspec"

- name: reboot hosts
  hosts: $hosts
  user: root

  tasks:
  - name: see if it needs to be rebooted
    action: command /usr/local/bin/needs-reboot.py
    ignore_errors: True
    register: needsreboot

  - name: reboot the host
    action: command touch /tmp/would-reboot
#/sbin/reboot
    only_if: "'${needsreboot.stdout}'.find('yes') != -1"

  - name: wait for host to come back - up to 6 minutes
    local_action: wait_for host=${inventory_hostname} port=22 delay=10 timeout=420
    only_if: "'${needsreboot.stdout}'.find('yes') != -1"



