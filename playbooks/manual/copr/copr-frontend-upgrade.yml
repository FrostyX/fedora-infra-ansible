---
- name: upgrade copr frontend
  hosts: copr_front_dev_aws:copr_front_aws
  user: root
  gather_facts: True

  vars:
    cache_file: /var/lib/copr/.ansible-copr-frontend-version

  vars_files:
   - /srv/web/infra/ansible/vars/global.yml
   - "/srv/private/ansible/vars.yml"
   - /srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml

  tasks:
  - name: Generic upgrade tasks for copr servers
    import_tasks: _generic_tasks.yml

  - name: Check for copr-frontend update
    shell: dnf clean expire-cache ; dnf check-update copr-frontend
    register: frontend_has_update
    changed_when: "frontend_has_update.rc != 0"
    failed_when: false

  - name: Check if HTTPD is running
    shell: systemctl status httpd
    register: httpd_running
    changed_when: "httpd_running.rc != 0"
    failed_when: false

  - name: Shutdown httpd to allow running DB migrations
    shell: timeout 20 systemctl stop httpd || systemctl kill httpd
    when:
    - frontend_has_update.changed
    - httpd_running.changed

  - name: Upgrade copr-frontend packages
    dnf:
      state: latest
      name:
      - copr-frontend
      - copr-frontend-fedora
      - copr-selinux
      - python3-copr-common

  - name: upgrade db to head
    command: alembic-3 upgrade head
    become: yes
    become_user: copr-fe
    args:
      chdir: /usr/share/copr/coprs_frontend/
    when: frontend_has_update.changed

  - name: make httpd started
    service: name=httpd state=started

  handlers:
  - import_tasks: "{{ handlers_path }}/restart_services.yml"
