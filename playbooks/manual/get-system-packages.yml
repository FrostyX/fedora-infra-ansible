#
# A playbook to get all the rpms installed on a set of systems. 
# 

- name: Get installed packages
  hosts: builders:releng-compose:data-analysis01.phx2.fedoraproject.org
  gather_facts: false
  user: root

  vars_files:
  - /srv/web/infra/ansible/vars/global.yml
  - "/srv/private/ansible/vars.yml"
  - "/srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml"


  tasks:

  - name: yum_command 
    yum: list=installed
    register: yum_packages
    when: ansible_distribution_major_version|int < 22

  - name: dnf_command
    dnf: list=installed
    register: dnf_packages
    when: ansible_distribution_major_version|int > 21

  - debug: msg="{{ inventory_hostname}} {{ yum_packages.results }}"
    when: yum_packages is defined and yum_packages.results|length > 0

  - debug: msg="{{ inventory_hostname}} {{ dnf_packages.results }}"
    when: yum_packages is defined and yum_packages.results|length > 0

  # - debug: 
  #   var: yum_packages
  #     var=item
  #     with_items: "{{yum_packages|json_query(jsonquery)}}"
  #   vars:
  #     jsonquery: "results[?name=='tar']"
  #   when: yum_packages is defined and yum_packages.results|length > 0

  # - debug:
  #   var: dnf_packages
  #     var=item
  #     with_items: "{{dnf_packages|json_query(jsonquery)}}"
  #   vars:
  #     jsonquery: "results[?name=='tar']"
  #   when: yum_packages is defined and yum_packages.results|length > 0

#
#
