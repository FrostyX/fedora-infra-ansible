- name: provision instance
  hosts: 209.132.184.98   # this is transient.. so may change if we destroy it.
  user: root
  gather_facts: True

  vars_files: 
   - /srv/web/infra/ansible/vars/global.yml
   - "/srv/private/ansible/vars.yml"
   - /srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml

  tasks:
  - include: "{{ tasks }}/yumrepos.yml"
  - yum: name={{item}} state=present
    with_items:
    - htop
    - tmux
    - vim
    - git
    - redis
    - python-pip
    - gcc
    - gcc-c++
    - sqlite-devel
    - libffi-devel
    - openssl-devel
    - python-datanommer-consumer
    - datanommer-commands
    - fedmsg-hub
    - python-psycopg2
    - postgresql-devel
    - postgresql-server
  - file: dest=/srv/git state=directory
  - git: repo=https://pagure.io/fedora-hubs.git
         dest=/srv/git/fedora-hubs
         version=develop
  - name: link in a number of files we want
    file: src={{item.src}} dest={{item.dest}} state=link
    with_items:
    - src: /srv/git/fedora-hubs/fedmsg.d/testconfig.py
      dest: /etc/fedmsg.d/testconfig.py
    - src: /srv/git/fedora-hubs/fedmsg.d/base.py
      dest: /etc/fedmsg.d/base.py
    - src: /srv/git/fedora-hubs/fedmsg.d/logging.py
      dest: /etc/fedmsg.d/logging.py
    - src: /srv/git/fedora-hubs/systemd/hubs-worker@.service
      dest: /usr/lib/systemd/system/hubs-worker@.service
    - src: /srv/git/fedora-hubs/systemd/hubs-triage@.service
      dest: /usr/lib/systemd/system/hubs-triage@.service
    - src: /srv/git/fedora-hubs/systemd/hubs-webapp.service
      dest: /usr/lib/systemd/system/hubs-webapp.service
  - command: pip install -r requirements.txt
             chdir=/srv/git/fedora-hubs
             creates=/usr/lib/python2.7/site-packages/fedmsg/

  # The one in epel7 is too old... :(
  - command: pip install --upgrade pygments

  - command: pip install futures
             creates=/usr/lib/python2.7/site-packages/concurrent/futures/
  - command: python setup.py develop
             chdir=/srv/git/fedora-hubs
             creates=/usr/lib/python2.7/site-packages/fedora-hubs.egg-link

  - command: systemctl daemon-reload

  - service: name={{item}} state=running enabled=yes
    with_items:
    - redis
    - hubs-webapp
    - hubs-worker1
    - hubs-triage1

  # Set up the db for datanommer
  - command: postgresql-setup initdb creates=/var/lib/pgsql/data/pg_hba.conf
