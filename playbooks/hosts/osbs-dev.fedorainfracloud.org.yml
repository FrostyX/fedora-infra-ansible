- name: check/create instance
  hosts: osbs-dev.fedorainfracloud.org
  gather_facts: False

  vars_files:
    - /srv/web/infra/ansible/vars/global.yml
    - /srv/private/ansible/vars.yml
    - /srv/web/infra/ansible/vars/fedora-cloud.yml
    - /srv/private/ansible/files/openstack/passwords.yml

  tasks:
  - include: "{{ tasks }}/persistent_cloud.yml"

- name: setup all the things
  hosts: osbs-dev.fedorainfracloud.org
  vars_files:
    - /srv/web/infra/ansible/vars/global.yml
    - /srv/private/ansible/vars.yml
    - /srv/private/ansible/files/openstack/passwords.yml
    - /srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml

  pre_tasks:
    - include: "{{ tasks }}/cloud_setup_basic.yml"
    - name: set hostname (required by some services, at least postfix need it)
      shell: "hostname {{inventory_hostname}}"

- name: bootstrap ansible py2
  hosts: osbs-dev.fedorainfracloud.org
  gather_facts: false
  tasks:
    - name: install python and deps for ansible modules
      raw: dnf install -y python2 python2-dnf libselinux-python libsemanage-python python-firewall

- name: setup osbs
  hosts: osbs-dev.fedorainfracloud.org
  vars_files:
    - /srv/web/infra/ansible/vars/global.yml
    - /srv/private/ansible/vars.yml
    - /srv/private/ansible/files/openstack/passwords.yml
    - /srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml

  roles:
    - osbs-atomic-reactor
    - osbs-common
    - osbs-install-openshift
    - osbs-master
    - {
      role: osbs-client,
        default: {
          openshift_url: 'https://osbs-dev.fedorainfracloud.org:8443/',
          registry_uri: 'https://osbs-dev.fedorainfracloud.org:5000/v2',
          source_registry_uri: 'https://osbs-dev.fedorainfracloud.org:5000/v2',
          build_host: 'osbs-dev.fedorainfracloud.org',
          koji_root: 'http://koji.fedoraproject.org/koji',
          koji_hub: 'http://koji.fedoraproject.org/kojihub',
          sources_command: 'fedpkg sources',
          build_type: 'prod',
          authoritative_registry: 'registry.example.com',
          vendor: 'Fedora Project',
          verify_ssl: false,
          use_auth: false,
          builder_use_auth: true,
          distribution_scope: 'private',
          registry_api_versions: 'v2',
          builder_openshift_url: 'https://172.17.0.1:8443/'
        }
      }
    - {
      role: docker-distribution,
        cert: {
          private_path: "files/osbs/osbs-dev.certs",
          dir: "/etc/pki/docker/osbs-dev.fedorainfracloud.org:5000/",
          src_name: "osbs-dev.fedorainfracloud.org.crt",
          src_key_name: "osbs-dev.fedorainfracloud.org.key",
          dest_name: "ca.crt",
          dest_key_name: "ca.key"
        },
        tls: {
          enabled: True,
          certificate: "/etc/pki/docker/osbs-dev.fedorainfracloud.org:5000/ca.crt",
          key: "/etc/pki/docker/osbs-dev.fedorainfracloud.org:5000/ca.key",
        }
      }

- name: post-install osbs tasks
  hosts: osbs-dev.fedorainfracloud.org
  vars_files:
    - /srv/web/infra/ansible/vars/global.yml
    - /srv/private/ansible/vars.yml
    - /srv/private/ansible/files/openstack/passwords.yml
    - /srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml
  vars:
    osbs_kubeconfig_path: /etc/origin/master/admin.kubeconfig
    osbs_environment:
      KUBECONFIG: "{{ osbs_kubeconfig_path }}"


  tasks:
    - name: install docker
      action: "{{ ansible_pkg_mgr }} name=docker-distribution state=installed"

    - name: ensure docker daemon cert dir exists
      file:
        path: "/etc/docker/certs.d/"
        state: directory

    - name: create symlink for docker daemon cert
      file:
        dest: "/etc/docker/certs.d/osbs-dev.fedorainfracloud.org:5000"
        src: "/etc/pki/docker/osbs-dev.fedorainfracloud.org:5000"
        state: "link"

    - name: start and enable docker
      service: name=docker state=started enabled=yes

    - name: create fedora image stream for OpenShift
      shell: 'echo { "apiVersion": "v1", "kind": "ImageStream", "metadata": { "name": "fedora" }, "spec": { "dockerImageRepository": "osbs-dev.fedorainfracloud.org:5000/fedora" } } | oc create -f -'
      environment: "{{ osbs_environment }}"
