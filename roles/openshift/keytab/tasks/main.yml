- name: Create temporary file
  tempfile: state=file
  register: tmpfile
  run_once: true

- name: Acquire a keytab
  include_role:
    name: keytab/service
  vars:
    kt_location: "{{ tmpfile.path }}"

- name: Call `oc secrets new` on the copied file
  shell: oc -n {{app}} secrets new {{secret_name}} {{key}}={{tmpfile.path}}
  run_once: true
  register: create_out
  failed_when: "create_out.rc != 0 and 'AlreadyExists' not in create_out.stderr"

- name: Delete temporary file
  file: path={{tmpfile.path}} state=absent
  run_once: true
