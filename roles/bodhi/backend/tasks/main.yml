---
# tasklist for setting up bodhi/masher (requires bodhi/base)
# This is the base set of files needed for bodhi/masher

- name: add ftpsync group
  group: name=ftpsync gid=263 system=yes state=present

- name: add ftpsync user
  user: name=ftpsync uid=263 group=ftpsync createhome=yes system=yes state=present

- name: add the ftpsync update-fullfilelist script
  copy: src=update-fullfilelist dest=/usr/local/bin/update-fullfilelist owner=ftpsync group=ftpsync mode=555

- name: add masher group
  group: name=masher gid=751 system=yes state=present

# masher user 751
- name: add masher user as 751 - and group
  user: name=masher uid=751 group=masher home=/home/masher groups=mock,ftpsync

- name: install needed packages
  yum: pkg={{ item }} state=present
  with_items:
  - python-fedora-turbogears
  tags:
  - packages

- name: install bodhi-masher /etc/httpd/conf.d/bodhi.conf file
  copy: >
    src="bodhi-masher.conf"
    dest="/etc/httpd/conf.d/bodhi.conf"
    owner=root
    group=root
    mode=0644
  notify:
  - restart httpd
  tags:
  - config

- name: change owner and group attributes of bodhi.pem file
  file: >
    path="/etc/pki/bodhi/bodhi.pem"
    owner=masher
    group=masher
  when: inventory_hostname.startswith('bodhi-backend')
  tags:
  - config

- name: change owner and group attributes of /var/log/bodhi directory
  file: path=/var/log/bodhi owner=masher group=masher
  when: inventory_hostname.startswith('bodhi-backend')
  tags:
  - config
  
- name: setup /etc/bodhi/mash.conf file...
  template: >
    src=mash.conf
    dest=/etc/bodhi/mash.conf
    owner=masher
    group=masher
    mode=0640
  tags:
  - config

- name: change type part of SELinux file context
  file: >
    dest=/var/tmp/bodhi/comps/
    setype=httpd_sys_script_rw_t
    state=directory
    recurse=yes
  tags:
  - config

- name: change owner attribute of /var/tmp/bodhi-bz.cookie file
  file: >
    path=/var/tmp/bodhi-bz.cookie 
    owner=masher 
  tags:
  - config

- name: install /etc/bodhi/*.mash files
  copy: >
    src="{{ item }}"
    dest="/etc/bodhi/{{ item }}"
    owner=masher
    mode=0640
  with_items:
  - f20-updates.mash
  - f20-updates-testing.mash
  - f21-updates.mash
  - f21-updates-testing.mash
  - f22-updates.mash
  - f22-updates-testing.mash
  - el6-epel.mash
  - el6-epel-testing.mash
  - epel7.mash
  - epel7-testing.mash
  tags:
  - config

# tasks for setting up epelmasher

- name: install needed packages
  yum: pkg={{ item }} state=present
  with_items:
  - repoview
  tags:
  - packages

- name: install bodhi-epel-masher /etc/bodhi/bodhi.cfg file
  template: >
    src="bodhi-epel-masher.cfg.j2" 
    dest="/etc/bodhi/bodhi.cfg" 
    owner=masher 
    group=masher 
    mode=0600
  when: inventory_hostname.startswith('bodhi-backend02')
  notify:
  - restart httpd
  tags:
  - config

# tasklist for setting up jobrunner

- name: install bodhi-masher-jobrunner /etc/bodhi/bodhi.cfg file
  template: >
    src="bodhi-masher-jobrunner.cfg.j2" 
    dest="/etc/bodhi/bodhi.cfg" 
    owner=masher 
    group=masher 
    mode=0600
  when: inventory_hostname.startswith('bodhi-backend01')
  notify:
  - restart httpd
  tags:
  - config
