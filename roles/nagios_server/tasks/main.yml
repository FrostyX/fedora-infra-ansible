- name: Add nagios group as 420
  group: name=nagios gid=420 state=present system=yes

- name: Add nagios user as 420
  user: name=nagios uid=420 state=present home=/var/spool/nagios comment="Nagios Monitoring User" createhome=yes system=yes shell=/bin/bash

# Add the apache user to the nagios group so that it has permissions
# to do stuff in /var/spool/nagios/*
- name: Add apache to nagios group
  user: name=apache append=yes groups=nagios
    
- name: Install nagios packages
  yum: name={{ item }} state=installed
  with_items:
  - php
  - nagios-plugins-http
  - nagios-plugins-dns
  - nagios-plugins-dig
  - nagios-plugins-ssh
  - nagios-plugins-nagios
  - nagios-plugins-nrpe
  - nagios-plugins-tcp
  - nagios-plugins-pgsql
  - nagios-plugins-smtp
  - nagios.x86_64
  #'nagios-plugins', # gets this from also being in ::client
  #- python-xmpp # TODO: rhel7
  - perl-Mail-IMAPClient
  - nagios-plugins-dummy
  #- nsca        # TODO: rhel7
  #- nsca-client # TODO: rhel7
  - stunnel

# TODO: rhel7
#- name: Restart and autostart nsca
#  service: name=nsca state=restarted enabled=yes

- name: Copy /etc/nagios config
  copy: src=nagios/ dest=/etc/nagios owner=nagios group=nagios

- name: Copy checkcommands.cfg
  template: src=nagios/checkcommands.cfg dest=/etc/nagios/checkcommands.cfg owner=nagios group=nagios

- name: Copy httpd config
  template: src=nagios-httpd.conf dest=/etc/httpd/conf.d/nagios.conf

- name: Create eventhandlers directory
  file: dest=/usr/lib/nagios/plugins/eventhandlers/ state=directory

- name: Copy plugins
  copy: src=plugins dest=/usr/lib/nagios/plugins/ mode=0755 owner=root group=root

# TODO: rhel7
#- name: Copy xmpp plugin config
#  file: src={{puppet_private}}/xmppnagios.ini dest=/etc/nagios/private/xmppnagios.ini mode=0660 owner=nagios group=nagios

- name: Create log directory
  file: dest=/var/log/nagios state=directory group=nagios owner=nagios mode=0755

- name: Create spool directory
  file: dest=/var/log/nagios/spool state=directory group=nagios owner=nagios mode=0755

- name: Create checkresults directory
  file: dest=/var/log/nagios/spool/checkresults state=directory group=nagios owner=nagios mode=0755

- name: Copy check_nagios_notifications.py
  copy: src=check_nagios_notifications.py dest=/usr/local/bin/check_nagios_notifications.py mode=0755 group=root owner=root

- name: Nuke default nagios passwd
  file: dest=/etc/nagios/passwd state=absent

- name: Nuke default nagios objects
  file: dest=/etc/nagios/objects state=absent

- name: Install check_nagios_notifications cron
  cron: name="check_nagios_notifications" minute=0 hour=0 weekday=1 user=nagios job="/usr/local/bin/check_nagios_notifications.py"

# TODO: Remove this for prod
- name: Shut services up for testing peacefully
  service: name={{item}} state=stopped enabled=no
  with_items:
  - postfix
  - rsyslog

- name: Restart and autostart nagios
  service: name=nagios state=restarted enabled=yes

#class nagios::server_external inherits nagios::server {
#    File['/etc/nagios/'] {
#        source => 'puppet:///nagios/nagios-external/',
#    }
#
#    File['/etc/nagios/checkcommands.cfg'] {
#        content => template('nagios/nagios-external/checkcommands.cfg.erb'),
#    }
#
#    file { '/usr/share/nagios/html/side.html':
#        mode => 644,
#        owner => root,
#        group => root,
#        source => 'puppet:///nagios/side.html'
#    }
#
#    file { '/usr/share/nagios/html/config.inc.php':
#        mode => 644,
#        owner => root,
#        group => root,
#        source => 'puppet:///nagios/config.inc.php'
#    }
#
#
#}

#class nagiosPhysical{
#    include ipmitool-package
#    file { '/usr/lib/nagios/plugins/check_ipmi':
#        source => 'puppet:///nagios/plugins/check_ipmi',
#        mode => 755,
#        owner => root,
#        group => root,
#        require => [Package['nagios-plugins'], Package['ipmitool']]
#    }
#}

#class nrpe {
#    if ($operatingsystem == "RedHat" and $operatingsystemrelease >= 6) {
#        selinux-policy::custom { 'nrpe': }
#    }
#    
#    package { 'nrpe': ensure => installed }
#    
#    service { 'nrpe':
#        enable => true,
#        ensure => running,
#        subscribe => File['/etc/nagios/nrpe.cfg']
#    }
#    
#    file { '/etc/nagios/nrpe.cfg':
#        source => 'puppet:///nagios/nrpe.cfg',
#        require => Package[nrpe],
#        # notify  => Service[nrpe]
#    }
#}

#class nagiossymlink { # Is this a hack? Is it still needed?
#    symlink { '/usr/lib/nagios':
#        replace => false,
#        ensure => '/usr/lib64/nagios/',
#        require => Package['nagios-plugins']
#    }
#}
