---

- name: install needed packages
  yum: pkg={{ item }} state=present
  with_items:
  - git
  - nodejs
  - npm
  - postgresql
  - postgresql-server
  tags:
  - packages

- name: Initialize postgres if necessary
  command: /usr/bin/postgresql-setup initdb
           creates=/var/lib/pgsql/data
  notify:
  - restart postgresql

- name: Create database
  postgresql_db: name=regcfp

- name: Create postgres db user
  postgresql_user: db=regcfp name=regcfp
                   password="{{ regcfp_db_password }}"
                   priv=CONNECT/regcfp:ALL

- name: Clone the regcfp flock2016 branch
  git: repo=https://github.com/puiterwijk/regcfp.git
       dest=/srv/regcfp
       version=flock2016
       clone=yes update=yes

# TODO: Find EPEL packages for these
- name: Install dependencies
  command: /bin/npm install
           chdir=/srv/regcfp
  register: deps
  changed_when: "deps.stdout|length > 0"

- name: copy over the server config
  template: src=config.json dest=/srv/regcfp/config/config.json mode=0640
  notify:
  - restart regcfp
  
- name: copy over the systemd file
  copy: src=regcfp.service dest=/etc/systemd/system/regcfp.service mode=0640
  notify:
  - restart regcfp

- name: regcfp service
  service: name=regcfp state=started enabled=yes
