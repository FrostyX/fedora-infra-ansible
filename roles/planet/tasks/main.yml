---
# tasks to setup a planet server
#

- name: add planet group
  group: name=planet-user gid=104 system=yes state=present
  tags:
    - planet_server

- name: add planet user
  user: name=planet-user uid=104 gid=104 home=/srv/planet comment="People Planet Eater" createhome=yes system=yes shell=/bin/bash
  tags:
    - planet_server
    
- name: add apache to planet group
  user: name=apache append=yes groups=planet-user
  tags:
    - planet_server

- name: ad planet config directory
  file: path=/etc/planet state=directory owner=root group=root mode=0775
  tags:
    - planet_server

- name: base planet config files
  copy: src=fpbuilder.conf dest=/etc/planet/fpbuilder.conf mode=0644 owner=root group=root
  tags:
    - planet_server
  
- name: create planet directory
  file: path={{ item }} state=directory owner=planet-user group=web mode=0775
  with_item:
    - /srv/planet
    - /srv/planet/site
    - /srv/planet/config

- name: install the planet packages
  yum:  pkg={{item}} state=present
  with_items:
    - venus
  tags:
    - planet_server

- name: copy the planet cron job
  copy: src=planet-cron dest=/etc/cron.d/planet-cron
  tags:
    - planet_server

- name: copy the planet http config file
  copy: src=planet-httpd.conf dest=/etc/httpd/conf.d/planet.conf
  tags:
    - planet_server

- name: copy the run planet-config script
  copy: src=pull-run-planet-config.sh dest=/usr/local/bin/pull-run-planet-config.sh
  tags:
    - planet_server

- name: copy the run-planet script
  copy: src=run-planet.sh dest=srv/planet/config/run-planet
  tags:
    - planet_server

##
## This is the area where we put in each sub-planets congfigs
##
- name: create sub-planet for {{ argv }}
  file: path={{ item }} state=directory owner=planet-user group=web mode=0775
  with_item:
    - /srv/planet/site/people/
    - /srv/planet/site/people/css
    - /srv/planet/site/people/images
    - /srv/planet/site/people/images/heads
    - /srv/planet/config/people
    - /srv/planet/config/people/templates
  tags:
    - planet_people    

- name: copy base people config file
  copy: src=people_base_config dest=/etc/planet/people_base_config
  tags:
    - planet_people
 
- name: copy over trees to site
  copy: src=sub-planets/people/site/css dest=/srv/planet/site/people/css
  tags:
    - planet_people
