- name: add libvirt remote user
  user:
    name: "{{ libvirt_user }}"
    groups: kvm

- name: add ssh key for libvirt remote user
  authorized_key:
    user: "{{ libvirt_user }}"
    path: /home/{{ libvirt_user }}/.ssh/authorized_keys
    key: "{{ libvirt_remote_pubkey }}"

- name: add polkit rule for users in kvm group
  copy:
    src: polkit/10-libvirt.rules
    dest: /etc/polkit-1/rules.d/10-libvirt.rules
    owner: root
    group: root
    mode: 0644

- name: get vm list
  virt: command=list_vms
  register: result
  always_run: yes

- name: generate libvirt xml files for clients
  template:
    src: client-libvirt.xml.j2
    dest: /home/{{ libvirt_user }}/{{ item.hostname }}.libvirt.xml
    owner: "{{ libvirt_user }}"
    group: "{{ libvirt_user }}"
  when: item.hostname not in result.list_vms
  with_items: clients
  sudo: true
  sudo_user: "{{ libvirt_user }}"

- name: ensure the guest lvs are created
  lvol: lv={{ item.hostname }} vg={{ volgroup }} size={{ item.lvm_size }} state=present
  when: item.hostname not in result.list_vms
  with_items: clients

- name: ensure vms are defined
  command: "virsh define --file /root/{{ item.hostname }}.libvirt.xml"
  when: item.hostname not in result.list_vms
  with_items: clients
  sudo: true
  sudo_user: "{{ libvirt_user }}"

