---
# Configuration for MirrorManager's crawler

- name: clean yum metadata
  command: yum clean all
  tags:
  - packages

- name: install needed packages
  yum: pkg={{ item }} state=present
  with_items:
  - httpd
  - mirrormanager2-crawler
  - python-psycopg2
  - fedmsg
  - fedmsg-relay
  tags:
  - packages

- name: create /etc/mirrormanager
  file: path=/etc/mirrormanager state=directory

- name: install MM configuration file
  template: src={{ roles }}/mirrormanager/frontend2/templates/mirrormanager2.cfg
            dest=/etc/mirrormanager/mirrormanager2.cfg
            mode=600 owner=mirrormanager group=mirrormanager
  tags:
  - config

- name: install the cron job
  copy: src=crawler.cron dest=/etc/cron.d/mm2_crawler.cron
  tags:
  - config

- name: install configuration file
  template: src={{ roles }}/mirrormanager/crawler/files/mirrormanager.conf
            dest=/etc/httpd/conf.d/mirrormanager.conf
            owner=apache group=apache mode=0600
  notify:
  - restart httpd
  tags:
  - config

- name: apply selinux type to crawler log files
  file: >
    dest=/var/log/mirrormanager/crawler
    setype=httpd_sys_content_t
    state=directory
    recurse=yes
