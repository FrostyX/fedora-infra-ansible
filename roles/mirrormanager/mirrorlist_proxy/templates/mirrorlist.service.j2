[Unit]
Description=Mirrorlist Container {{ item }}

[Service]
Restart=on-failure
User=mirrormanager
ExecStartPre=-/usr/bin/podman stop -t 1 %n
ExecStartPre=-/usr/bin/podman rm %n --force
ExecStartPre=/usr/bin/rm -f /%t/run/{{ mirrormanager_uid }}/%n-pid /%t/run/{{ mirrormanager_uid }}/%n-cid
ExecStart=/usr/bin/podman run \
            --conmon-pidfile /%t/run/{{ mirrormanager_uid }}/%n-pid \
            --cidfile /%t/run/{{ mirrormanager_uid }}/%n-cid \
            --net=host --userns=keep-id \
            --rm=true --name %n \
            -v /usr/share/GeoIP:/usr/share/GeoIP \
            -v /srv/mirrorlist/data/mirrorlist{{ item }}:/var/lib/mirrormanager \
            -v /var/log/mirrormanager:/var/log/mirrormanager \
{% if env == "staging" %}
            {{ mirrorlist_container_image_stg }} \
{% else %}
            {{ mirrorlist_container_image }} \
{% endif %}
                 --port 1808{{ item }} \
                 --listen 127.0.0.1 \
                 -l /var/log/mirrormanager/%n.log
ExecStop=/usr/bin/sh -c "/usr/bin/podman rm -f `cat /%t/run/{{ mirrormanager_uid }}/%n-cid`"
KillMode=none
Type=forking
PIDFile=/%t/run/{{ mirrormanager_uid }}/%n-pid

[Install]
WantedBy=multi-user.target
