# Openstack has a newer version of rabbitmq
- name: Install RHOSP13 repo file
  copy: src="{{ files }}/newcloud/rhos13.repo" dest=/etc/yum.repos.d/rhos13.repo
  tags:
  - rabbitmq_cluster
  - config
  - packages
  - yumrepos

- name: install needed packages
  package: name={{ item }} state=present
  with_items:
  - rabbitmq-server
  tags:
  - rabbitmq_cluster
  - packages

- name: deploy CA certificate
  copy: src="{{private}}/files/rabbitmq/{{env}}/pki/ca.crt"
        dest=/etc/rabbitmq/ca.crt
        owner=root group=root mode=0644
  tags:
  - rabbitmq_cluster
  - config

- name: create node cert directory
  file: path=/etc/rabbitmq/nodecert/ owner=root group=root mode=0755 state=directory
  tags:
  - rabbitmq_cluster
  - config

- name: deploy node certificate
  copy: src="{{private}}/files/rabbitmq/{{env}}/pki/issued/{{inventory_hostname}}.crt"
        dest=/etc/rabbitmq/nodecert/node.crt
        owner=root group=root mode=0644
  tags:
  - rabbitmq_cluster
  - config

- name: deploy node private key
  copy: src="{{private}}/files/rabbitmq/{{env}}/pki/private/{{inventory_hostname}}.key"
        dest=/etc/rabbitmq/nodecert/node.key
        owner=rabbitmq group=rabbitmq mode=0600
  tags:
  - rabbitmq_cluster
  - config

- name: build combined node key
  assemble: src=/etc/rabbitmq/nodecert/ dest=/etc/rabbitmq/nodecert.combined.pem
            owner=rabbitmq group=rabbitmq mode=0600
  tags:
  - rabbitmq_cluster
  - config

- name: enable plugins
  copy: src=enabled_plugins dest=/etc/rabbitmq/enabled_plugins owner=root group=root mode=0644
  with_items:
  - rabbitmq.config
  - enabled_plugins
  tags:
  - rabbitmq_cluster
  - config

- name: deploy configuration
  template: src={{item}} dest=/etc/rabbitmq/{{item}} owner=root group=root mode=0644
  with_items:
  - rabbitmq.config
  - rabbitmq-env.conf
  tags:
  - rabbitmq_cluster
  - config

- name: deploy staging cookie
  copy: content="{{rabbitmq_cluster_cookie_staging}}" dest=/var/lib/rabbitmq/.erlang.cookie
        owner=rabbitmq group=rabbitmq mode=0600
  when: "env == 'staging'"
  tags:
  - rabbitmq_cluster
  - config

#- name: start rabbitmq
#  service: name=rabbitmq-server state=started enabled=yes
#  tags: rabbitmq
