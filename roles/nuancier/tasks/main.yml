---
# Configuration for the nuancier webapp

- name: clean yum metadata
  command: yum clean all
  tags:
  - packages

- name: install needed packages
  yum: pkg=$item state=installed
  with_items:
  - nuancier-lite
  - python-psycopg2
  - python-openid-cla
  - python-openid-teams
  - python-memcached
  tags:
  - packages

- name: copy sundry nuancier configuration
  template: src={{ item.file }}
            dest={{ item.location }}/{{ item.dest }}
            owner=apache group=apache mode=0600
  with_items:
  - { file: nuancier_admin.cfg, location: /etc/nuancier, dest: nuancier-lite.cfg }
  tags:
  - config
  notify:
  - restart apache

- name: create pictures folder where we upload the pictures
  action: file state=directory
               path=/var/www/nuancier/pictures
  tags:
  - setup

- name: create the cache folder where nuancier creates the thumbnails
  action: file state=directory
               path=/var/www/nuancier/cache
               owner=apache group=apache
  tags:
  - setup

- name: create the database scheme
  command: /usr/bin/python2 /usr/share/nuancier/nuancier-lite_createdb.py
  environment:
      NUANCIER_CONFIG: /etc/nuancier/nuancier-lite.cfg

- name: replace the nuancier configuration file by the one with the normal user
  template: src={{ item.file }}
            dest={{ item.location }}/{{ item.file }}
            owner=apache group=apache mode=0600
  with_items:
  - { file: nuancier-lite.cfg, location: /etc/nuancier }
  - { file: nuancier.conf, location: /etc/httpd/conf.d }
  - { file: nuancier.wsgi, location: /usr/share/nuancier }
  tags:
  - config
  notify:
  - restart apache

# FIXME: Probably need other selinux booleans and tweaks here
# seboolean action requires libsemanage-python to be installed.  Have to decide
# if we actually want to install that on the hosts.
# selinux is currently set to permissive due to other things that nuancier is
# trying to do.  So no harm in leaving this disabled for now.
#- name: set sebooleans so nuancier can talk to the db
#  action: seboolean name=httpd_can_network_connect_db
#                    state=true
#                    persistent=true

- name: hotfix nuancier to get an error message for people not in cla_plus_one
  template: src={{ item.file }}
            dest={{ item.location }}/{{ item.file }}
            owner=root group=root mode=0644
  with_items:
  - { file: __init__.py, location: /usr/lib/python2.6/site-packages/nuancier/__init__.py }
  tags:
  - config
  - hotfix
  notify:
  - restart apache

- name: hotfix nuancier to fix results page
  template: src={{ item.file }}
            dest={{ item.location }}/{{ item.file }}
            owner=root group=root mode=0644
  with_items:
  - { file: model.py, location: /usr/lib/python2.6/site-packages/nuancier/model.py }
  tags:
  - config
  - hotfix
  notify:
  - restart apache

- name: hotfix python-fedora-flask to include latest flask_fas_openid
  template: src={{ item.file }}
            dest={{ item.location }}/{{ item.file }}
            owner=apache group=apache mode=0600
  with_items:
  - { file: flask_fas_openid.py, location: /usr/lib/python2.6/site-packages/ }
  tags:
  - config
  notify:
  - restart apache
