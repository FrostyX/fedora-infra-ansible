# Optional vars
# - checkcompose_server
##      string - hostname of openQA server to connect to (if not set, openQA
##               client configuration will determine this, default will be
##               localhost)
# - checkcompose_url
##      string - base URL for openQA result links (if not set, will be
##               the URL the client actually wound up connecting to)
# - checkcompose_wait
##      string - (digits) time in minutes to wait for openQA tests to complete
##               before sending the report (defaults to 480)
# - checkcompose_emailfrom
##      string - Email address to send report from (if not set, no report sent)
# - checkcompose_emailto
##      string - Email address to send report to (if not set but email-from
##               set, report will go to email-from, for testing usually)
##               Split multiple addresses with spaces
# - checkcompose_atomic_emailto
##      string - Email address to send report for Fedora-Atomic composes to
##               Split multiple addresses with spaces
# - checkcompose_atomic_emailerror
##      string - Set to 'true' if reports for Fedora-Atomic composes should
##               only be mailed out if any tests did not pass
# - checkcompose_smtp
##      string - SMTP server to use for sending the report
# - checkcompose_json
##      string - File to append JSON-formatted report summary to
# - checkcompose_loglevel
##      string - log level
#
# NOTE: this is missing /etc/openqa/client.conf configuration, for now;
# we're assuming it'll be deployed on the openqa server boxes and hence
# client.conf will be in place (and localhost default would be correct
# anyhow)

#- name: Install required packages (testing)
#  dnf: name={{ item }} state=present enablerepo="updates-testing"
#  with_items:
#  - python2-fedfind
#  tags:
#  - packages

- name: Install required packages (Python 2)
  dnf:
    name: ['python2-fedfind', 'python2-fedmsg', 'python2-openqa_client',
           'python2-setuptools', 'python2-six']
    state: present
  when: "'python34-fedmsg' not in group_names"
  tags:
  - packages

- name: Install required packages (Python 3)
  dnf:
    name: ['python3-fedfind', 'python3-fedmsg', 'python3-openqa_client',
           'python3-setuptools', 'python3-six']
    state: present
  when: "'python34-fedmsg' in group_names"
  tags:
  - packages

- name: Check if Python 2 check-compose is installed
  find:
    paths: /usr/lib/python2.7/site-packages
    patterns: "check_compose*"
  register: py2ccinstalled
  changed_when: "1 != 1"
  failed_when: "1 != 1"
  check_mode: no

- name: Check out check-compose
  git:
    repo: https://pagure.io/fedora-qa/check-compose.git
    dest: /root/check-compose
  register: gitcc

- name: Install check-compose (Python 2)
  command: "python2 setup.py install --nodeps"
  args:
    chdir: /root/check-compose
  when: "gitcc is changed and 'python34-fedmsg' not in group_names"
  notify:
  - restart fedmsg-hub

- name: Install python2-pip if needed to remove py2 check-compose
  dnf:
    name: python2-pip
    state: present
  when: "py2ccinstalled is defined and py2ccinstalled.files and 'python34-fedmsg' in group_names"
  tags:
  - packages

- name: Remove check-compose (Python 2)
  command: "pip2 uninstall --disable-pip-version-check --yes check-compose"
  when: "py2ccinstalled is defined and py2ccinstalled.files and 'python34-fedmsg' in group_names"
  notify:
  - restart fedmsg-hub

- name: Install check-compose (Python 3)
  command: "python3 setup.py install --nodeps"
  args:
    chdir: /root/check-compose
  when: "(gitcc is changed or (py2ccinstalled is defined and py2ccinstalled.files)) and 'python34-fedmsg' in group_names"
  notify:
  - restart fedmsg-hub

- name: Enable fedmsg consumer
  template: src=checkcomp_consumer.py.j2 dest=/etc/fedmsg.d/checkcomp_consumer.py owner=root group=root mode=0644
  notify:
  - restart fedmsg-hub
  tags:
  - config

- name: Remove Python 2 packages
  dnf:
    name: ['python2-fedfind', 'python2-openqa_client']
    state: absent
  when: "'python34-fedmsg' in group_names"
  tags:
  - packages

- name: Install config file
  template: src=check-compose.conf.j2 dest=/etc/check-compose.conf mode=0644
  tags:
  - config
