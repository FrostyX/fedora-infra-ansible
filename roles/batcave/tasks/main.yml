#
# This role sets up the various packages and scripts needed for a batcave
#

#
# make directory for nfs mounts to live in
#

- name: create /srv/web/pub for nfs mounts
  file: dest=/srv/web/pub state=directory mode=755
  tags:
  - batcave
  - config

- name: install packages needed
  yum: pkg={{ item }} state=present
  with_items:
  - srm                       # secure rm to delete sensitive files.
  - ansible                   # This is our ansible master, needs ansible installed.
  - ansible-openstack-modules # Needed to manage cloud with ansible
  tags:
  - batcave
  - config

# 
# This is our ansible master, setup ansible
#

- name: use our ansible.cfg
  copy: src=ansible.cfg dest=/etc/ansible/ansible.cfg
  tags:
  - batcave
  - config

- name: setup roots bashrc to note about agents
  copy: src=root_bashrc dest=/root/.bashrc
  tags:
  - batcave
  - config

- name: run daily logview report for ansible actions. 
  copy: src=logview.cron dest=/etc/cron.daily/logview.cron
  tags:
  - batcave
  - config
 
#
# Set selinux booleans we need
#

- name: set selinux booleans
  seboolean: name={{ item }} persistent=yes state=yes
  with_items:
  - httpd_can_network_connect
  - httpd_use_nfs
  - httpd_can_network_relay
  tags:
  - batcave
  - config

#
# This script checks all the virthosts and logs what guests they are running. 
#

#- name: install vmdiff.sh cron
#  copy: src=vmdiff.sh dest=/etc/cron.hourly/vmdiff.sh mode=0755
#  tags:
#  - batcave
#  - config

#
# Setup public db copy script.
#

#- name: setup public db copy script
#  copy: src=public-db-copy.cron dest=/etc/cron.daily/public-db-copy.cron mode=0755
#  tags:
#  - batcave
#  - config

#
# Setup job that runs a check/diff ansible run over all playbooks each night.
#

#- name: setup checkdiff ansible job
#  copy: src=ansible-playbook-check-diff.cron dest=/etc/cron.daily/ansible-playbook-check-diff.cron mode=0755
#  tags:
#  - batcave
#  - config


# still to convert from puppet:
#    include scripts::check-sshkeys
#    include scripts::git-notifier
#    include scripts::retrieve-security-question
#    include scripts::sync-openshift-keys
#    include scripts::zodbotAnnounceCommits
#    include scripts::fedmsgAnnounceCommits
#    include scripts::sync-rhn
#
#    include repo2json
#    include ansible_utils::ansible_utils
#
#    include rsync::server
#    include scripts::geoip-retriever
#    include geoip-retriever
#
#    httpd::site { "infrastructure.fedoraproject.org": }
#
#    httpd::mime-type { "restructured text docs":
#        website => "infrastructure.fedoraproject.org",
#        mimetype => "text/plain",
#        extensions => [ ".rst" ],
