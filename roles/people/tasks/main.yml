---
#
# Install packages needed for fedora people
#
- name: install packages needed for fedora people
  yum: name={{ item }} state=present
  with_items:
  - cvs
  - git
  - bzr
  - mercurial
  - lftp
  - quota
  - nano
  - pyliblzma
  tags:
  - packages
  - people

- name: install httpd config
  copy: src={{item}} dest=/etc/httpd/conf.d/{{item}}
  with_items:
  - cgit.conf
  - people.conf
  - planet.conf
  - ssl.conf
  tags:
  - people

- name: start httpd
  service: name="httpd" state=started
  tags:
  - people

- name: set selinux booleans needed for people
  seboolean: name={{ item }} state=true persistent=true
  with_items:
  - httpd_enable_homedirs
  - git_cgi_enable_homedirs
  - git_system_enable_homedirs
  tags:
  - people

- name: check the selinux context of the users home git dirs
  command: matchpathcon "/home/fedora/(/.*)/public_git(/.*)?"
  register: gitcontext
  always_run: yes
  changed_when: false
  tags:
  - config
  - selinux

- name: set the SELinux policy for the users home git dirs
  command: semanage fcontext -a -t git_user_content_t "/home/fedora/(.*)/public_git(.*)"
  when: gitcontext.stdout.find('git_user_content_t') == -1
  tags:
  - config
  - selinux

#
# This sets the default, it's safe to always run. 
# Default quota for users is 2gb
#
- name: set default xfs quotas on /srv
  command: xfs_quota -x -c 'limit bsoft=2g bhard=2g -d' /srv
  always_run: true
  register: xfs_quotaoutput
  changed_when: "xfs_quotaoutput.rc != 0"
  tags:
  - people
  - peoplequotas

#
# This sets quotas for people who requested more than default
# It's also safe to aways run.
#
- name: set quotas for people who have more set
  command: xfs_quota -x -c 'limit bsoft={{ item.quota }} bhard={{ item.quota }} {{ item.user }}' /srv
  with_items:
  - { user: apache, quota: 0 }
  - { user: dmarlin, quota: 5g }
  - { user: duffy, quota: 10g }
  - { user: dwalsh, quota: 5g }
  - { user: jdulaney, quota: 5g }
  - { user: jnovy, quota: 5g }
  - { user: kashyapc, quota: 5g }
  - { user: lupinix, quota: 8g }
  - { user: mimccune, quota: 3g }
  - { user: nobody, quota: 0 }
  - { user: npmccallum, quota: 5g }
  - { user: parasense, quota: 5g }
  - { user: planet-user, quota: 0 }
  - { user: ppisar, quota: 4g }
  - { user: pulpadmin, quota: 10g }
  - { user: sapnetweavergatewayonfedora, quota: 5g }
  - { user: slagle, quota: 7g }
  - { user: spot, quota: 15g }
  - { user: spstarr, quota: 4g }
  - { user: steved, quota: 5g }
  - { user: tekkamanninja, quota: 5g }
  - { user: tflink, quota: 10g }
  - { user: thunderbirdtr, quota: 3g }
  - { user: zpericic, quota: 5g }
  always_run: true
  register: xfs_quotaoutput
  changed_when: "xfs_quotaoutput.rc != 0"
  tags:
  - people
  - peoplequotas
