#
# Install needed packages
#
- name: Install needed nfs server packages
  package: name={{ item }} state=present
  with_items:
  - nfs-utils
  - rpcbind
  tags:
  - nfs/server

## THis should be in a different playbook. 
- name: create copr storage
  lvol: vg=VG_nfs lv=copr-dist-git size=10t shrink=no
  when: inventory_hostname == 'storinator01.fedorainfracloud.org'
  tags:
  - nfs/server

- name: Create FS for copr
  filesystem: fstype=xfs dev=/dev/VG_nfs/copr-dist-git
  when: inventory_hostname == 'storinator01.fedorainfracloud.org'
  tags:
  - nfs/server

- name: create 5 GB communishift logical volumes
  lvol: vg=VG_nfs lv=openshift-05gb-{{item}} size=5g shrink=no
  with_items: 00 01 02 03 04 05 06 07 08 09
  when: inventory_hostname == 'storinator01.fedorainfracloud.org'
  tags:
  - nfs/server

- name: Create FS for 5 GB communishift logical volules
  filesystem: fstype=xfs dev=/dev/VG_nfs/openshift-05gb-{{item}}
  with_items: 00 01 02 03 04 05 06 07 08 09
  when: inventory_hostname == 'storinator01.fedorainfracloud.org'
  tags:
  - nfs/server

- name: create 10 GB communishift logical volumes
  lvol: vg=VG_nfs lv=openshift-10gb-{{item}} size=10g shrink=no
  with_items: 00 01 02 03 04 05 06 07 08 09
  when: inventory_hostname == 'storinator01.fedorainfracloud.org'
  tags:
  - nfs/server

- name: Create FS for 10 GB communishift logical volules
  filesystem: fstype=xfs dev=/dev/VG_nfs/openshift-10gb-{{item}}
  with_items: 00 01 02 03 04 05 06 07 08 09
  when: inventory_hostname == 'storinator01.fedorainfracloud.org'
  tags:
  - nfs/server

- name: create 25 GB communishift logical volumes
  lvol: vg=VG_nfs lv=openshift-25gb-{{item}} size=25g shrink=no
  with_items: 00 01 02 03 04 05 06 07 08 09
  when: inventory_hostname == 'storinator01.fedorainfracloud.org'
  tags:
  - nfs/server

- name: Create FS for 25 GB communishift logical volules
  filesystem: fstype=xfs dev=/dev/VG_nfs/openshift-25gb-{{item}}
  with_items: 00 01 02 03 04 05 06 07 08 09
  when: inventory_hostname == 'storinator01.fedorainfracloud.org'
  tags:
  - nfs/server

- name: setup /etc/exports
  copy: src={{ inventory_hostname }}-exports dest=/etc/exports
  register: exports
  tags:
  - nfs/server

- name: enable nfs-related services and run them (fedora)
  service: name={{ item }}  enabled=true state=started
  with_items:
  - nfs-idmap
  - rpc-statd
  when: ansible_distribution == 'Fedora'
  tags:
  - nfs/server

- name: enable nfs-related services and run them (rhel)
  service: name={{ item }}  enabled=true state=started
  with_items:
  - rpcbind
  - nfs-server
  - nfs-lock
  when: ansible_distribution == 'RedHat'
  tags:
  - nfs/server

- name: Kick exportfs if /etc/exports changed
  command: /usr/sbin/exportfs -ra
  when: exports.changed
  tags:
  - nfs/server

