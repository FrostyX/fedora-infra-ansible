---
# Configuration for the fedbadges consumer

- name: install needed packages
  yum: pkg=$item state=installed
  with_items:
  - python-fedbadges
  - python-psycopg2
  tags:
  - packages

- name: copy database configuration
  template: >
    src=$item dest=/etc/fedmsg.d/$item
    owner=fedmsg group=fedmsg mode=0600
  with_items:
  - datanommer.py
  - badges-awarder.py
  tags:
  - config
  notify:
  - restart fedmsg-hub

- name: make badge definition directory
  file: >
    path=/usr/share/badges/rules
    state=directory
    owner=fedmsg group=fedmsg mode=0755
  tags:
  - config
  - badges

# Here I'm "permanently" hotfixing the fedmsg-hub
# It needs to load the forward-compat sqlalchemy0.7 package from the get-go.
- name: copy over patched fedmsg-hub
  copy: >
    src=patched-fedmsg-hub dest=/usr/bin/fedmsg-hub
    owner=root group=root mode=0755
  tags:
  - patches
  - hotfix
  notify:
  - restart fedmsg-hub

- name: copy over all our badge definitions
  copy: >
    src=$item
    dest=/usr/share/badges/rules/
    owner=fedmsg group=fedmsg mode=0644
  with_fileglob:
  - /srv/web/infra/badges/rules/*.yml
  tags:
  - config
  - badges
  notify:
  - restart fedmsg-hub


- name: ensure badges cron directories exist
  file: >
    state=directory
    path=$item
    mode=755
    owner=root
  with_items:
  - /usr/share/badges/cronjobs/
  - /etc/cron.d/
  tags:
  - config
  - cron

- name: oldschool badge award scripts
  copy: >
    src=$item
    dest=/usr/share/badges/cronjobs/$item
    owner=root
    mode=644
  with_items:
  - award-oldschool-badges
  tags:
  - config
  - cron

- name: oldschool badge award cronjobs
  copy: >
    src=$item
    dest=/etc/cron.d/$item
    owner=root
    mode=644
  with_items:
  - award-oldschool-badges
  tags:
  - config
  - cron
