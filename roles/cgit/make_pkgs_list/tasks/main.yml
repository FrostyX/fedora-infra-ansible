---
# tasklist for setting up the CGit file list

- name: create the git root directory (/srv/git)
  file: dest=/srv/git state=directory mode=0755

- name: ensure the repo list file exists
  file: path=/srv/git/pkgs-git-repos-list state=touch owner=apache group=apache mode=0644

- name: install the script
  copy: src=make-cgit-pkgs-list.sh dest=/usr/local/bin/make-cgit-pkgs-list.sh mode=0755

- name: install the cron job
  cron: >
    name="make-cgit-pkgs-list" cron_file="ansible-make-cgit-pkgs-list"
    minute=*/10
    user=root
    job="/usr/local/bin/lock-wrapper make-cgit-pkgs-list '/usr/local/bin/make-cgit-pkgs-list.sh | /usr/local/bin/nag-once fassync 1d 2>&1'"

- name: check the selinux context of the repo list
  command: matchpathcon /srv/git/pkgs-git-repos-list
  register: gitlistcontext
  always_run: yes
  changed_when: false
  tags:
  - config
  - cgit
  - selinux

- name: set the SELinux policy for the repo list
  command: semanage fcontext -a -t httpd_git_content_t "/srv/git/pkgs-git-repos-list"
  when: gitlistcontext.stdout.find('httpd_git_content_t') == -1
  tags:
  - config
  - cgit
  - selinux
