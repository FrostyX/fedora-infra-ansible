- name: prepare resultsdb database
  hosts: "{{ resultsdb_db_host }}"
  gather_facts: no
  sudo: yes
  sudo_user: postgres

  tasks:
    - name: ensure dev database is created
      action: postgresql_db db={{ resultsdb_db_name }}

    - name: ensure dev resultsdb db user has access to dev database
      when: deployment_type == 'dev'
      action: postgresql_user db={{ resultsdb_db_name }} user={{ dev_resultsdb_db_user }} password={{ dev_resultsdb_db_password }} role_attr_flags=NOSUPERUSER

    - name: ensure stg resultsdb db user has access to stg database
      when: deployment_type == 'stg'
      action: postgresql_user db={{ resultsdb_db_name }} user={{ stg_resultsdb_db_user }} password={{ stg_resultsdb_db_password }} role_attr_flags=NOSUPERUSER

    - name: ensure prod resultsdb db user has access to prod database
      when: deployment_type == 'prod'
      action: postgresql_user db={{ resultsdb_db_name }} user={{ prod_resultsdb_db_user }} password={{ prod_resultsdb_db_password }} role_attr_flags=NOSUPERUSER

