---
# Configuration for IPA

- name: install needed packages
  yum: pkg={{ item }} state=present
  with_items:
  - haveged
  - ipa-server
  - ipa-server-dns
  tags:
  - ipa
  - packages

- name: enable haveged
  service: name=haveged state=started enabled=yes
  tags:
  - haveged
  - config

- name: install IPA
  command: ipa-server-install
           --realm={{ipa_realm}}
           --domain={{ipa_realm}}
           --ds-password={{ipa_dm_password}}
           --admin-password={{ipa_admin_password}}
           --mkhomedir
           --no-ntp
           --unattended
           --no-ssh
           --no-sshd
           --setup-dns
           --forwarder=10.5.126.21
           --forwarder=10.5.126.22
           --log-file=/var/log/ipainstall.log
           creates=/etc/ipa/default.conf
  tags:
  - ipa
  - config
  when: inventory_hostname.startswith("ipa01")

- name: create replica file
  delegate_to: ipa01.phx2.fedoraproject.org
  command: ipa-replica-prepare
           --password={{ipa_dm_password}}
           --ip-address={{eth0_ip}}
           creates=/var/lib/ipa/replica-info-{{inventory_hostname}}.gpg
  tags:
  - ipa
  - config
  when: env != "staging" and not inventory_hostname.startswith("ipa01")

- name: retrieve replica file
  delegate_to: ipa01.phx2.fedoraproject.org
  fetch: src=/var/lib/ipa/replica-info-{{inventory_hostname}}.gpg
         dest=/tmp/ipa_replica_{{inventory_hostname}}
  tags:
  - ipa
  - config
  when: env != "staging" and not inventory_hostname.startswith("ipa01")

#
# switch this to use the systemd module as soon as ansible 2.2 is out.
#

#- name: mask kadmin
#  file: src=/dev/null
#        dest=/etc/systemd/system/kadmin.service
#        owner=root group=root state=link
#  tags:
#  - ipa
#  - config
