apiVersion: v1
items:
- apiVersion: v1
  kind: BuildConfig
  metadata:
    labels:
      build: bodhi-base
    name: bodhi-base
  spec:
    runPolicy: Serial
    source:
      dockerfile: |-
        FROM fedora:32
        LABEL \
          name="bodhi-base" \
          vendor="Fedora Infrastructure" \
          license="MIT"
        RUN curl -o /etc/yum.repos.d/infra-tags.repo https://infrastructure.fedoraproject.org/cgit/ansible.git/plain/files/common/fedora-infra-tags.repo
        # While dnf has a --nodocs, it doesen't have a --docs...
        RUN sed -i '/nodocs/d' /etc/dnf/dnf.conf
        RUN dnf install -y bodhi-server-{{bodhi_version}} bodhi-docs-{{bodhi_version}} python3-pyramid_sawing python3-gunicorn
        RUN curl -o /usr/lib/python3.8/site-packages/bodhi/server/models.py https://raw.githubusercontent.com/cverna/bodhi/fix_editing_updates/bodhi/server/models.py &&\
            curl -o /usr/lib/python3.8/site-packages/bodhi/server/tasks/__init__.py https://raw.githubusercontent.com/cverna/bodhi/fix_editing_updates/bodhi/server/tasks/__init__.py &&\
            curl -o /usr/lib/python3.8/site-packages/bodhi/server/util.py https://raw.githubusercontent.com/cverna/bodhi/fix_editing_updates/bodhi/server/util.py &&\
            curl -o /usr/lib/python3.8/site-packages/bodhi/server/tasks/updates.py https://raw.githubusercontent.com/cverna/bodhi/fix_editing_updates/bodhi/server/tasks/updates.py &&\
            curl -o /usr/lib/python3.8/site-packages/bodhi/server/tasks/tag_update_builds.py https://raw.githubusercontent.com/cverna/bodhi/fix_editing_updates/bodhi/server/tasks/tag_update_builds.py &&\
            curl -o /usr/lib/python3.8/site-packages/bodhi/server/tasks/handle_side_and_related_tags.py https://raw.githubusercontent.com/cverna/bodhi/fix_editing_updates/bodhi/server/tasks/handle_side_and_related_tags.py &&\
            curl -o /usr/lib/python3.8/site-packages/bodhi/server/services/updates.py https://raw.githubusercontent.com/cverna/bodhi/fix_editing_updates/bodhi/server/services/updates.py

        # Set up krb5
        RUN rm -f /etc/krb5.conf && \
            ln -sf /etc/bodhi/krb5.conf /etc/krb5.conf && \
            ln -sf /etc/keytabs/koji-keytab /etc/krb5.bodhi_bodhi{{ env_suffix }}.fedoraproject.org.keytab
        ENV USER=openshift
      type: Dockerfile
    strategy:
      type: Docker
      dockerStrategy:
        noCache: false
    output:
      to:
        kind: ImageStreamTag
        name: bodhi-base:latest
kind: List
metadata: {}
