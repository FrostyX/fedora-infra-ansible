apiVersion: v1
kind: BuildConfig
metadata:
  name: "greenwave-docker-build"
  labels:
    environment: "greenwave"
spec:
  runPolicy: Serial
  source:
    dockerfile: |-
      FROM fedora:25
      LABEL \
          name="Greenwave" \
          vendor="Fedora Infrastructure" \
          license="MIT"
      RUN yum -y install --setopt=tsflags=nodocs \
          git \
          python-gunicorn \
          python-requests \
          PyYAML \
          python2-flask
  {% if env == 'staging' %}
      # https://pagure.io/greenwave/pull-request/62
      # https://pagure.io/greenwave/pull-request/63
      RUN git clone -b special-relevance https://pagure.io/greenwave.git /srv/greenwave
      RUN ln -s /etc/greenwave/settings.py /srv/greenwave/conf/settings.py
      WORKDIR /srv/greenwave
  {% else %}
      RUN yum -y install --setopt=tsflags=nodocs \
            greenwave
  {% endif %}
      EXPOSE 8080
      ENTRYPOINT gunicorn --bind 0.0.0.0:8080 --access-logfile=- greenwave.wsgi:app
  strategy:
    type: Docker
  output:
    to:
      kind: ImageStreamTag
      name: greenwave:latest
