apiVersion: v1
kind: BuildConfig
metadata:
  labels:
    build: ipsilon
  name: ipsilon
spec:
  runPolicy: Serial
  source:
    dockerfile: |-
      FROM fedora:31
      RUN curl -o /etc/yum.repos.d/infra-tags.repo https://infrastructure.fedoraproject.org/infra/ansible/files/common/fedora-infra-tags.repo
{% if env == "staging" %}
      RUN curl -o /etc/yum.repos.d/infra-tags-stg.repo https://infrastructure.fedoraproject.org/infra/ansible/files/common/fedora-infra-tags-stg.repo
      RUN curl -o /etc/yum.repos.d/fedora-updates-testing.repo https://src.fedoraproject.org/rpms/fedora-repos/raw/master/f/fedora-updates-testing.repo
{% endif %}
      RUN dnf install -y \
{% if env == "staging" %}
          --enablerepo=updates-testing \
{% endif %}
          ipsilon \
          ipsilon-openid \
          ipsilon-saml2 \
          ipsilon-persona \
          ipsilon-authgssapi \
          ipsilon-authldap \
          ipsilon-openidc \
          ipsilon-theme-Fedora \
          mod_auth_openidc \
          python-psycopg2 \
          python-setuptools \
          python-jinja2 \
          httpd \
          python3-mod_wsgi \
          git

      # Fedora specific stuff
      RUN cd /tmp && \
          git clone --branch {{ env }} https://pagure.io/fedora-infra/ipsilon-fedora.git && \
          cd ipsilon-fedora && \
          ./install.sh

      # Cleanup
      RUN dnf remove -y git && rm -rf /tmp/ipsilon-fedora

      # Set up krb5
      RUN rm -f /etc/krb5.conf && ln -sf /etc/ipsilon/krb5.conf /etc/krb5.conf

      RUN ln -s /etc/ipsilon/ipsilon.conf /var/lib/ipsilon/ipsilon.conf

      EXPOSE 8080
      ENTRYPOINT bash /etc/ipsilon/start.sh
    type: Dockerfile
  strategy:
    type: Docker
  output:
    to:
      kind: ImageStreamTag
      name: ipsilon:latest
