---

- name: Install python and deps for ansible modules
  raw: dnf install -y python2 python2-dnf libselinux-python

- name: Install stuff
  dnf: name={{ item }} state=latest
  with_items:
    # Those things are explicitly listed in Vagrantfile
    # https://pagure.io/fm-orchestrator/blob/master/f/Vagrantfile
    # Should they be covered by spec file?
    - fedmsg-hub
    - fedmsg-relay
    - fedpkg
    - gcc
    - gcc
    - gcc-c++
    - git
    - koji
    - krb5-workstation
    - libffi-devel
    - openssl-devel
    - python
    - python-devel
    - python-devel
    - python-flask
    - python-mock
    - python-virtualenv
    - redhat-rpm-config
    - redhat-rpm-config
    - rpm-build
    - swig
    - systemd-devel

    # Required for copr
    # @TODO Get there a new version to fix - AttributeError: 'CoprClient' object has no attribute 'get_module_repo'
    - copr-cli


# Install module-build-service
- name: Enable copr-dev repo
  command: dnf -y copr enable frostyx/module-build-service

- name: Install module-build-service package
  #dnf: name=module-build-service state=latest
  #command: dnf -y install https://frostyx.fedorapeople.org/module-build-service-1.0.2-1.fc24.noarch.rpm
  command: dnf -y install https://kojipkgs.fedoraproject.org//packages/module-build-service/1.0.2/2.fc26/noarch/module-build-service-1.0.2-2.fc26.noarch.rpm


# Post-install stuff
- name: Copy config to fedmsg.d (probably workarounding .spec here)
  command: creates=/etc/fedmsg.d/module_build_service.py
    cp /etc/module-build-service/fedmsg.d/module_build_service.py /etc/fedmsg.d/

- name: FOO
  #command: grep -q '^127\.0\.0\.1 fedmsg-relay$' /etc/hosts || echo "127.0.0.1 fedmsg-relay" >> /etc/hosts
  command: echo "127.0.0.1 fedmsg-relay" >> /etc/hosts

- name: FOO
  #command: echo "export KRB5CCNAME=FILE:/var/tmp/krbcc" > /etc/profile.d/module_build_service_developer_env.sh
  lineinfile: dest=/etc/profile.d/module_build_service_developer_env.sh create=yes state=present line='export KRB5CCNAME=FILE:/var/tmp/krbcc'

- name: FOO
  #command: echo "export MODULE_BUILD_SERVICE_DEVELOPER_ENV=1" >> /etc/profile.d/module_build_service_developer_env.sh
  lineinfile: dest=/etc/profile.d/module_build_service_developer_env.sh state=present line='export MODULE_BUILD_SERVICE_DEVELOPER_ENV=1'

# - name: FOO
#   command: source /etc/profile.d/module_build_service_developer_env.sh


# Create user and group for mbs
- name: Create group for mbs-frontend
  group: name=mbs state=present

- name: Create user for mbs-frontend
  user: name=mbs group=mbs




# @FIXME
- name: Export krbcc
  command: echo 'export KRB5CCNAME=FILE:/var/tmp/krbcc' >> ~/.bashrc

- name: Set properties in config
  replace:
    dest: /etc/module-build-service/config.py
    regexp: '^    {{ item.key }} = .*$'
    replace: '    {{ item.key }} = {{ item.value }}'
    backup: yes
  with_items:
    - { key: 'SYSTEM', value: '"copr"'}
      #- { key: 'REQUIRE_PACKAGER', value: 'False'}
      #- { key: 'OIDC_CLIENT_SECRETS', value: '"/etc/module-build-service/client_secrets.json"'}


# @TODO Should be packaged in module_build_service package? Or we need to create our own?
- name: Obtain client_secrets.json
  command: wget https://pagure.io/fm-orchestrator/raw/master/f/conf/client_secrets.json -P /etc/module-build-service/


# @TODO Should be packaged in module-build-service package? Or should already exist on copr-frontend instance?
- name: Copy cacert.pem
  command: wget https://pagure.io/fm-orchestrator/raw/master/f/conf/cacert.pem -O /etc/module-build-service/cacert.pem



- name: Upgrade database
  command: mbs-upgradedb

- name: Generate cert
  command: mbs-gencert


# Run module-build-service processes
- name: Enable fedmsg-relay
  service: name=fedmsg-relay enabled=yes state=started

- name: Run fedmsg-hub
  service: name=fedmsg-hub enabled=yes state=started


# @FIXME Use apache instead
- name: Run mbs-frontend
  #service: name=mbs-frontend enabled=yes state=started
  shell: nohup mbs-frontend < /dev/null >& /tmp/mbs-frontend.out &

- name: copy apache files to conf.d
  copy: src=httpd/mbs.conf dest=/etc/httpd/conf.d/mbs.conf
  tags:
  - config


# Only for testing purposes
# Use it as:  python submit_build.py 127.0.0.1:5000
- name: Download submit_build.py
  command: wget https://pagure.io/fm-orchestrator/raw/master/f/contrib/submit_build.py

- name: Download submit-build.json
  command: wget https://pagure.io/fm-orchestrator/raw/master/f/contrib/submit-build.json
