- name: Check current crypto-policy
  command: "update-crypto-policies --show"
  register: currentcryptopolicy
  failed_when: "1 != 1"
  changed_when: "1 != 1"
  tags:
  - crypto-policies
  - base/crypto-policies

- name: Check if policy is applied
  command: "update-crypto-policies --is-applied"
  register: cryptopolicyapplied
  failed_when: "1 != 1"
  changed_when: "1 != 1"
  tags:
  - crypto-policies
  - base/crypto-policies

- debug:
  msg: "admv is {{ ansible_distribution_major_version }} ccp is {{ currentcryptopolicy.stdout }} cpa is {{ cryptopolicyapplied.rc }} "

- name: Set crypto-policy on fedora 33 and higher hosts to allow 2fa to work
  command: "update-crypto-policies --set LEGACY"
  when: "ansible_distribution_major_version|int >= 33 and (currentcryptopolicy.stdout.find('LEGACY') == -1 or cryptopolicyapplied.rc != 0)"
  tags:
  - crypto-policies
  - base/crypto-policies
