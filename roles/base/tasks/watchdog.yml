- name: See if theres a watchdog device
  stat: path=/dev/watchdog
  when: ansible_virtualization_role == 'guest'
  register: watchdog_dev

- name: install watchdog
  yum: pkg={{ item }} state=present
  with_items:
  - watchdog
  tags:
  - packages
  - watchdog
  - base
  when: ansible_distribution_major_version|int < 22 and ansible_virtualization_role == 'guest' and watchdog_dev.stat.exists

- name: install watchdog
  dnf: pkg={{ item }} state=present
  with_items:
  - watchdog
  tags:
  - packages
  - watchdog
  - base
  when: ansible_distribution_major_version|int > 21 and ansible_virtualization_role == 'guest' and watchdog_dev.stat.exists

- name: watchdog device configuration
  copy: src=watchdog.conf dest=/etc/watchdog.conf owner=root group=root mode=644
  when: ansible_virtualization_role == 'guest' and watchdog_dev.stat.exists
  tags:
  - config
  - watchdog
  - base
  notify: restart watchdog

- name: Set watchdog to run on boot
  service: name=watchdog enabled=yes
  when: ansible_virtualization_role == 'guest' and watchdog_dev.stat.exists
  ignore_errors: true
  notify:
  - restart watchdog
  tags:
  - service
  - watchdog
  - base
