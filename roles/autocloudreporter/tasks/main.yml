# This role reports Autocloud results to ResultsDB. There should
# always be exactly one host in infra with this role set up and
# autocloudreporter_prod set to True, so all results are reported
# once.
#
# Required vars
#
# Required vars with defaults
# - autocloudreporter_prod
##       bool - whether this is the production instance. **SHOULD ONLY
##              EVER BE TRUE ON ONE SYSTEM IN THE WORLD**
##       default - False

- name: Install required packages (Python 2)
  dnf:
    name: ['python2-fedfind', 'python2-fedmsg', 'python2-resultsdb_api',
           'python2-resultsdb_conventions-fedora', 'python2-setuptools']
    state: present
  when: "'python34-fedmsg' not in group_names"
  tags:
  - packages

- name: Install required packages (Python 3)
  dnf:
    name: ['python3-fedfind', 'python3-fedmsg', 'python3-resultsdb_api',
           'python3-resultsdb_conventions-fedora', 'python3-setuptools']
    state: present
  when: "'python34-fedmsg' in group_names"
  tags:
  - packages

- name: Check if Python 2 autocloudreporter is installed
  find:
    paths: /usr/lib/python2.7/site-packages
    patterns: "autocloudreporter*"
  register: py2acrinstalled
  changed_when: "1 != 1"
  failed_when: "1 != 1"
  check_mode: no

- name: Check out autocloudreporter
  git:
    repo: https://pagure.io/fedora-qa/autocloudreporter.git
    dest: /root/autocloudreporter
  register: gitacr

- name: Install autocloudreporter (Python 2)
  command: "python2 setup.py install"
  args:
    chdir: /root/autocloudreporter
  when: "gitacr is changed and 'python34-fedmsg' not in group_names"
  notify:
  - restart fedmsg-hub

- name: Install python2-pip if needed to remove py2 autocloudreporter
  dnf:
    name: python2-pip
    state: present
  when: "py2acrinstalled is defined and py2acrinstalled.files and 'python34-fedmsg' in group_names"
  tags:
  - packages

- name: Remove autocloudreporter (Python 2)
  command: "pip2 uninstall --disable-pip-version-check --yes autocloudreporter"
  when: "py2acrinstalled is defined and py2acrinstalled.files and 'python34-fedmsg' in group_names"
  notify:
  - restart fedmsg-hub

- name: Install autocloudreporter (Python 3)
  command: "python3 setup.py install"
  args:
    chdir: /root/autocloudreporter
  when: "(gitacr is changed or (py2acrinstalled is defined and py2acrinstalled.files)) and 'python34-fedmsg' in group_names"
  notify:
  - restart fedmsg-hub

- name: Enable fedmsg consumer
  template: src=autocloudreporter.py.j2 dest=/etc/fedmsg.d/autocloudreporter.py owner=root group=root mode=0644
  notify:
  - restart fedmsg-hub
  tags:
  - config

- name: Remove Python 2 packages
  dnf:
    name: ['python2-fedfind', 'python2-resultsdb_api', 'python2-resultsdb_conventions-fedora']
    state: absent
  when: "'python34-fedmsg' in group_names"
  tags:
  - packages
