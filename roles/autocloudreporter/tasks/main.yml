# This role reports Autocloud results to ResultsDB. There should
# always be exactly one host in infra with this role set up and
# autocloudreporter_prod set to True, so all results are reported
# once.
#
# Required vars
# - wikitcms_token
##      string - a token file to install for unattended wiki editing
#                using openidc auth
# - autocloudreporter_amqp_queue
##      string - Message queue name for the consumer. To use the
##               fedora-messaging scheduler with public authentication
##               on the Fedora production AMQP broker (which is what
##               you'd typically want), you only need to set this.
##               This should be a unique and private string; the
##               official recommendation is to use a random UUID
##               generated by uuidgen.
# - autocloudreporter_amqp_resultsdburl
##      string - API URL of the ResultsDB instance to report results to.
#
# Required vars with defaults
# - autocloudreporter_amqp_passive
##        bool - If true, passive_declares will be set true in all the
##               fedora-messaging consumer configuration files. This
##               is needed for private authentication on the Fedora
##               brokers.
##       default - False
# - autocloudreporter_amqp_url
##      string - AMQP broker URL for fedora-messaging autocloud reporter.
##               The role default for this is the Fedora production
##               broker with the shared 'fedora' username.
# - autocloudreporter_amqp_cacert
##      string - CA certificate file to use for authenticating with
##               AMQP broker for fedora-messaging autocloud reporter.
##               The role default for this is the CA cert file for the
##               Fedora production broker.
# - autocloudreporter_amqp_cert
##      string - Certificate file to use for authenticating with AMQP
##               broker for fedora-messaging autocloud reporter. The role
##               default for this is the certificate file for the
##               public 'fedora' account on the Fedora production
##               broker.
# - autocloudreporter_amqp_key
##      string - Private key file to use for authenticating with AMQP
##               broker for fedora-messaging autocloud reporter. The role
##               default for this is the key file for the public
##               'fedora' account on the Fedora production broker.
# - autocloudreporter_amqp_routing_keys
##        list - List of routing key names for the fedora-messaging
##               scheduler to subscribe to. The role default for this
##               is the appropriate keys for the Fedora production
##               broker.
# - autocloudreporter_amqp_mailfrom
##      string - From email address for error report emails. Defaults
##               to "root@{{ external_hostname }}". Only relevant if
##               autocloudreporter_amqp_mailto is set.
# - autocloudreporter_amqp_smtp
##      string - Hostname of SMTP server to use for sending error
##               emails. Defaults to 'localhost'. Only relevant if
##               autocloudreporter_amqp_mailto is set.
#
# Optional vars
# - autocloudreporter_amqp_mailto
##        list - List of email addresses to email errors to. If set,
##               the email log handler will be configured.

- name: Install required packages
  package:
    name: ['fedora-messaging', 'python3-fedfind', 'python3-resultsdb_api',
           'python3-resultsdb_conventions-fedora', 'python3-setuptools']
    state: present
  tags:
  - packages

- name: Check out autocloudreporter
  git:
    repo: https://pagure.io/fedora-qa/autocloudreporter.git
    dest: /root/autocloudreporter
  register: gitacr

- name: Install autocloudreporter
  command: "python3 setup.py install --nodeps"
  args:
    chdir: /root/autocloudreporter
  when: "gitacr is changed"
  notify:
  - restart autocloudreporter

- name: Create /etc/pki/fedora-messaging
  file:
    dest: /etc/pki/fedora-messaging
    mode: 0775
    owner: root
    group: root
    state: directory
  when: "deployment_type is defined"
  tags:
  - config

# We always use the openQA production cert and key here for now; we
# don't really need a separate identity for autocloudreporter. We don't
# use the staging identity as even staging autocloudreporter listens on
# the prod bus.
- name: Deploy the Fedora infra fedora-messaging cert (openQA production)
  copy:
    src: "{{ private }}/files/rabbitmq/production/pki/issued/openqa.crt"
    dest: /etc/pki/fedora-messaging/openqa-cert.pem
    mode: 0644
    owner: root
    group: root
  when: "deployment_type is defined"
  tags:
  - config

# This is kinda icky, as there's no intrinsic reason the group geekotest
# should exist so far as this role is concerned. But as we run this role
# on the same box as openQA, in fact we need to keep the ownership in
# line. This needs making cleaner somehow.
- name: Deploy the Fedora infra fedora-messaging key (openQA production)
  copy:
    src: "{{ private }}/files/rabbitmq/production/pki/private/openqa.key"
    dest: /etc/pki/fedora-messaging/openqa-key.pem
    mode: 0640
    owner: root
    group: geekotest
  when: "deployment_type is defined"
  tags:
  - config

- name: Configure fedora-messaging autocloudreporter
  template: src=autocloudreporter.toml.j2 dest=/etc/fedora-messaging/autocloudreporter.toml owner=root group=root mode=0640
  notify:
  - restart autocloudreporter
  tags:
  - config

- name: Wipe the old fedmsg consumer config file
  file: path=/etc/fedmsg.d/autocloudreporter.py state=absent
  notify:
  - restart fedmsg-hub
  tags:
  - config

- name: Enable and start fedora-messaging autocloudreporter
  service: name=fm-consumer@autocloudreporter enabled=yes state=started
